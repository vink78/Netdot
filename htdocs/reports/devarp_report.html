<%doc>
Device + ARP + FWT Report
</%doc>
<%attr>
title   => 'Device + ARP + FWT Report' 
section => 'Reports'
</%attr>
<%args>
$fwtable => '';
</%args>
<%init>
my $DEBUG      = 0;
my $rsql = "SELECT concat(rr.name, '.', zone.name), device.sysname, max(fwtable.id) as fwtable FROM rr, zone, device, fwtable WHERE fwtable.device=device.id AND rr.id=device.name AND rr.zone=zone.id group by device.sysname";
</%init>

<div class="container">
  <div class="containerhead">Device ARP+FWT Reports</div>
    <div class="containerbody">
    <strong>Device:</strong><br/>
    <form name="devarp_form" action="devarp_report.html" method="get">
      <select name="fwtable">
<%perl>
my $res = Netdot::Model->raw_sql( $rsql )->{rows};

foreach my $r ( @$res ) {
	my $selected = '';
	$selected = ' selected' if ($r->[2] == $fwtable);
	printf "<option value=\"%s\"%s>%s</option>\n", $r->[2], $selected, $r->[0];
}

</%perl>
      </select>
      <input type="Submit" Value="display"/>
    </form>
    </div>
  </div>
</div>

<%perl>
my ($host, $date) = ('', '');
my (@headers, @rows) = ();

if ($fwtable > 0) {
my $rsql = "
SELECT fwtableentry.interface, fwtableentry.physaddr, arp.ipaddr
FROM fwtableentry
JOIN interface ON interface.id=fwtableentry.interface
LEFT JOIN
  (SELECT ace.physaddr,ace.ipaddr,max(tstamp) as tstamp FROM arpcacheentry ace
   JOIN arpcache ac ON ac.id=ace.arpcache
   WHERE ac.tstamp >= timestampadd(hour,-48,now())
   GROUP BY ace.physaddr,ace.ipaddr
  ) AS arp ON arp.physaddr=fwtableentry.physaddr
WHERE fwtableentry.fwtable=$fwtable AND interface.neighbor IS NULL
ORDER BY CAST(interface.number AS SIGNED), fwtableentry.physaddr
";

my $rsql2 = "
SELECT CONCAT(rr.name, '.', zone.name), fwtable.tstamp
FROM fwtable, device, rr, zone
WHERE fwtable.id=$fwtable AND fwtable.device=device.id AND device.name=rr.id AND rr.zone=zone.id
";

@headers = ( 'Interface', 'MAC Address', 'IP Address', 'Host', );

my $res2 = Netdot::Model->raw_sql( $rsql2 )->{rows};
foreach my $r ( @$res2 ) {
    $host = $r->[0];
    $date = $r->[1];
}

my $res = Netdot::Model->raw_sql( $rsql )->{rows};
foreach my $r ( @$res ) {
    my @row = ();

    # Interface
    my $iface = Interface->retrieve($r->[0]);
    push ( @row, [$iface->number, '<a href="/netdot/management/interface.html?id='.$iface.'">'.$iface->name.'</a>'] );

    # MAC Address
    my $eth = PhysAddr->retrieve($r->[1]);
    push ( @row, [$eth->address, '<a href="/netdot/management/mac.html?id='.$eth.'">'.$eth->address.'</a>'] );

    if ($r->[2] ne '') {
	# IP Address
	my $ipb = Ipblock->retrieve($r->[2]);
	push ( @row, [$ipb->address_numeric, '<a href="/netdot/management/ip.html?id='.$ipb.'">'.$ipb->address.'</a>'] );

	# Host
	my @host;
	my $rr = '';
	foreach my $ar ( $ipb->a_records ) {
	    $rr = $ar->rr;
	    push (@host, '<a href="/netdot/management/host.html?table=RR&id='.$rr.'">'.$rr->get_label.'</a>');
	}
	if ($rr != '') {
	    push ( @row, [$rr->get_label, join (', ', @host)] );
	} else {
	    push ( @row, ['', '&nbsp;'] );
	}
    } else {
	push ( @row, ['', '&nbsp;'] );
	push ( @row, ['', '&nbsp;'] );
    }

    push( @rows, \@row );
}
</%perl>

<div class="container">
<div class="containerhead">IP+ARP For device <% $host %>, date <% $date %></div>
<div class="containerbody">
<p>
<& /generic/data_table2.mhtml, field_headers=>\@headers, data=>\@rows, style=>['', '', 'text-align: right', 'text-align: right'] &>
</p>
</div>
</div>
</div>
<%perl>
}
</%perl>
